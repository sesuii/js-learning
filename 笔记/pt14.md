<!--
 * @Author: _krill
 * @Date: 2022-08-16 20:13:36
 * @LastEditTime: 2022-08-16 22:57:40
 * @Description: 
-->

# asyn JS



## Ajax 调用

### `XMLHttpRequest` (old way)

```js
// 创建请求
const request = new XMLHttpRequest();
// 请求方式 请求链接
request.open('GET', `https://restcountries.com/v3.1/name/${country}`);
// 发送请求
request.send();
```

#### Request and Response

请求-响应模型 / CS 架构

![](../photo/CS%20arch.png)


### Promises and Fetch API (modern way)

> 发送多个 Ajax 请求时，无法保证数据到达顺序.
>
> 解决方法：嵌套回调，但回调过多时出现 Callback Hell，ES6 以后使用 Promises 避免回调地狱

Promises 是一个用作异步请求保存未来结果的占位符/容器，或者说异步传递值的容器。

**Promises 优点**

1. 使用 Promises，不需要依赖事件和回调函数来处理异步请求。

2. 使用 Promises，可以创建异步操作序列来保证请求结果按顺序展示，避免回调地狱。

``` js
const getCountryData = function (country) {
    fetch(`https://restcountries.com/v3.1/name/${country}`)
    // 这里的 json() 方法同样是异步，将返回一个新的 Promises
    .then(response => response.json())
    .then(data => renderCountry(data[0]));
}
```
![](../photo/Promises.png)

### Chaining Promises

避开 Callback hell，链式扁平化而非嵌套。

``` js
const getCountryData = function (country) {
    fetch(`https://restcountries.com/v3.1/name/${country}`)
    .then(response => response.json())
    .then(data => {
        renderCountry(data[0]);
        const neighbour = data[0].borders[0];

        if(!neighbour) return;
        return fetch(`https://restcountries.com/v3.1/alpha/${neighbour}`);
    })
    .then(response => response.json())
    .then(data => renderCountry(data[0], 'neighbour'));
}
```

### 处理 Rejected Promises

通过向 ferch().then() 传递第二个函数参数作为错误处理函数；或者更优解添加 `.catch()` ，其将顺着 Promises 链捕获出现的错误，例如出现离线情况.

但如果请求返回结果 404，仅仅是 `.catch` 不会自动捕获，此时应手动抛出错误.

```js
const getCountryData = function (country) {
    fetch(`https://restcountries.com/v3.1/name/${country}`)
        .then(response => {
            if(!response.ok) 
                throw new Error(`Country not found ${response.status}`);    
            return response.json()
        })
        .catch(err => renderError(`Something went wrong! ${err.message}, Try again!`))
        .finally(() => {
            countriesContainer.style.opacity = 1;
        });
}
```